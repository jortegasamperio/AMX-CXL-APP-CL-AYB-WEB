<div class="container">
    @if (isLoading()) {
    <div class="loading-container">
        <!--Poner la funcionalidad de loading  de las nubes-->
        <p>Cargando...</p>
    </div>
    } @else {
    <form class="formulario" [formGroup]="form" (ngSubmit)="save()">
        <!-- Campos globales que comparten todos los platillos para identificar el menú -->
        <div class="form_global">
            <mat-form-field class="mat_form" appearance="outline">
                <mat-label>No. Vuelo</mat-label>
                <input matInput placeholder="No. Vuelo" value="{{menuSearch()?.flightNumber || ''}}" disabled="true" />
            </mat-form-field>
            <mat-form-field class="mat_form" appearance="outline">
                <mat-label>Mes Ciclo</mat-label>
                <input matInput placeholder="Mes Ciclo" value="{{menuSearch()?.mesCiclo || ''}}" disabled="true" />
            </mat-form-field>
            <mat-form-field class="mat_form" appearance="outline">
                <mat-label>Año</mat-label>
                <input matInput placeholder="Año" value="{{menuSearch()?.annio || ''}}" disabled="true" />
            </mat-form-field>
        </div>
        <div class="platillo_add">
            <button class="add_platillo_btn" type="button" (click)="addPlatillo()">Agregar platillo</button>
        </div>
        <!-- Formulario dinámico que identifica cada platillo del menú -->
        <div formArrayName="platillo">
            @for (
            control of platilloArray.controls;
            track control;
            let index = $index
            ) {
            <!-- Formulario Platillos -->
            <div class="div_expansion_panel" [formGroupName]="index">
                <mat-expansion-panel [expanded]="false" (opened)="panelOpenState.set(true)"
                    (closed)="panelOpenState.set(false)">
                    <mat-expansion-panel-header>
                        <mat-panel-title>
                            Platillo No. {{getCodigoSpml(index)}}
                            <div class="div_btn_delete">
                                <button class="delete_platillo_btn" type="button" (click)="deleteDialog(index)">
                                    Delete
                                </button>
                            </div>
                        </mat-panel-title>
                    </mat-expansion-panel-header>
                    <div class="form_platillo">
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Código de alimento</mat-label>
                            <mat-select (selectionChange)="changeCodigo(index)" formControlName="codAlimento">
                                @for (codAlimento of dataFlightsByCode()?.foodCode; track codAlimento) {
                                <mat-option [value]="codAlimento">
                                    {{codAlimento}}
                                </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Código de servicio</mat-label>
                            <mat-select (selectionChange)="changeCodigo(index)" formControlName="codServicio">
                                @for (codServicio of dataFlightsByCode()?.foodService; track codServicio) {
                                <mat-option [value]="codServicio">
                                    {{codServicio}}
                                </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Cabina</mat-label>
                            <mat-select (selectionChange)="changeCodigo(index)" formControlName="cabina">
                                @for (cabina of dataFlightsByCode()?.cabyn; track cabina) {
                                <mat-option [value]="cabina">
                                    {{cabina}}
                                </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Ciclo</mat-label>
                            <mat-select (selectionChange)="changeCodigo(index)" formControlName="ciclo">
                                @for (ciclo of dataFlightsByCode()?.cycle; track ciclo) {
                                <mat-option [value]="ciclo">
                                    {{ciclo}}
                                </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Opción</mat-label>
                            <mat-select (selectionChange)="changeCodigo(index)" formControlName="opcion">
                                @for (opcion of dataFlightsByCode()?.option; track opcion) {
                                <mat-option [value]="opcion">
                                    {{opcion}}
                                </mat-option>
                                }
                            </mat-select>
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Tipo de menú</mat-label>
                            <input matInput placeholder="Tipo de menú" maxlength="15" formControlName="tipoMenu" />
                        </mat-form-field>
                        <mat-form-field class="mat_platillo" appearance="outline">
                            <mat-label>Código de preseleccion</mat-label>
                            <input matInput placeholder="Código de preseleccion" formControlName="codigoAlimento" />
                        </mat-form-field>
                        <div class="div_content_image">
                            <mat-form-field class="mat_image" appearance="outline">
                                <div class="div_img">
                                    <mat-toolbar class="mat_toolbar_img">
                                        <input matInput class="input_name" formControlName="nombreImg"
                                            [readonly]="true" />
                                    </mat-toolbar>

                                    <input class="input_img" type="file" id="fileInput" name="fileInput"
                                        accept="image/*" (change)="selectFiles($event, index)" />
                                </div>
                            </mat-form-field>
                            @if (!validateImgForm(index)) {
                            <div class="message_error">
                                Imagen requerida *
                            </div>
                            }
                        </div>
                        <div class="div_load_img">
                            <img [id]="'img-' + index" alt="" class="preview">
                        </div>
                    </div>
                    <!-- Tabs con los campos de Nombre y Descripción del platillo por idiomas -->
                    <div class="div_tab_content">
                        <mat-tab-group mat-stretch-tabs class="example-stretched-tabs mat-elevation-z4">
                            @for (tab of nombreCampos; track tab) {
                            <mat-tab label="{{tab.tab_name}}">
                                <div class="div_tab">
                                    <div class="tab_input">
                                        <mat-form-field appearance="outline">
                                            <mat-label>{{tab.form[0].name}}</mat-label>
                                            <input matInput placeholder="{{tab.form[0].name}}"
                                                formControlName="{{tab.form[0].control_Name}}"
                                                maxlength="120"
                                                onkeydown="return /[a-zA-ZÀ-ÿ, ]/i.test(event.key)">
                                        </mat-form-field>
                                    </div>
                                    <div class="tab_textarea">
                                        <mat-form-field appearance="outline">
                                            <mat-label>{{tab.form[1].name}}</mat-label>
                                            <textarea matInput placeholder="{{tab.form[1].name}}"
                                                formControlName="{{tab.form[1].control_Name}}"
                                                maxlength="255"
                                                onkeydown="return /[a-zA-ZÀ-ÿ, ]/i.test(event.key)"></textarea>
                                        </mat-form-field>
                                    </div>
                                </div>
                            </mat-tab>
                            }
                        </mat-tab-group>
                    </div>
                </mat-expansion-panel>
            </div>
            }
        </div>
        <div class="platillo_save">
            <button class="btn" type="button" (click)="redirectMenu()">Cancelar</button>
            <button class="btn" mat-flat-button [disabled]="isButtonDisabled()">Guardar</button>
        </div>
    </form>
    }
</div>